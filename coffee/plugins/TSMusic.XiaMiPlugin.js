// Generated by CoffeeScript 1.6.2
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  TSMusic.XiaMiPlugin = (function(_super) {
    __extends(XiaMiPlugin, _super);

    XiaMiPlugin.type = "xiami";

    function XiaMiPlugin(name) {
      var _this = this;

      XiaMiPlugin.__super__.constructor.call(this, name);
      this.lyric_url = "";
      this.div = document.getElementById("xiami-div");
      this.button = document.getElementById("browse-xiami");
      this.music_xiami = document.getElementById("music-xiami");
      this.submit_xiami = document.getElementById("submit-xiami");
      this.submit_xiami.onclick = function() {
        var value;

        value = _this.music_xiami.value.trim();
        if (value && !isNaN(value)) {
          return TSMusic.Loader.load("http://www.xiami.com/song/playlist/id/" + value, function(result) {
            var location, url;

            location = /<location>(.*?)<\/location>/.exec(result)[1];
            url = _this.url_decode(location);
            _this.lyric_url = /<lyric>(.*?)<\/lyric>/.exec(result)[1];
            return _this.widget.load(url);
          });
        } else {
          return alert("请输入正确的编号！");
        }
      };
      this.button.onclick = this.show.bind(this);
    }

    XiaMiPlugin.prototype.url_decode = function(id) {
      var cols, i, loc, output, p, right, rows, s, x, y;

      loc = id.indexOf("h");
      rows = parseInt(id.slice(0, loc));
      s = id.slice(loc);
      cols = Math.floor(s.length / rows);
      right = s.length % rows;
      output = "";
      i = 0;
      while (i < s.length) {
        x = i % rows;
        y = Math.floor(i / rows);
        p = 0;
        if (x <= right) {
          p = x * (cols + 1) + y;
        } else {
          p = right * (cols + 1) + (x - right) * cols + y;
        }
        output += s.charAt(p);
        i++;
      }
      return decodeURIComponent(output).replace(/\^/g, "0").replace(/%20/g, " ");
    };

    return XiaMiPlugin;

  })(TSMusic.BrowsePlugin);

}).call(this);
